version: '3'

silent: true

vars:
  ALL_FEATURES: backtrace,cosmwasm_1_1,cosmwasm_1_2,cosmwasm_1_3,iterator,staking,stargate
  ALL_FEATURES_1_0: backtrace,cosmwasm_1_1,cosmwasm_1_2,cosmwasm_1_3,iterator,staking,stargate,multitest_api_1_0

tasks:

  build-all:
    desc: Runs all build variants
    cmds:
      - task: build
      - task: build11
      - task: build12
      - task: build13
      - task: build_10

  build:
    desc: Builds the library in debug mode with all features
    cmds:
      - cmd: cargo +stable build --features {{.ALL_FEATURES}}

  build11:
    desc: Builds the library in debug mode with "cosmwasm_1_1" feature
    cmds:
      - cmd: cargo +stable build --features cosmwasm_1_1

  build12:
    desc: Builds the library in debug mode with "cosmwasm_1_2" feature
    cmds:
      - cmd: cargo +stable build --features cosmwasm_1_2

  build13:
    desc: Builds the library in debug mode with "cosmwasm_1_3" feature
    cmds:
      - cmd: cargo +stable build --features cosmwasm_1_3

  build_10:
    desc: Builds the library in debug mode with multitest_api_1_0 feature enabled
    cmds:
      - cmd: cargo +stable build --features {{.ALL_FEATURES_1_0}}

  build-and-test:
    desc: Circle CI equivalent of build_and_test job
    cmds:
      - cmd: cargo build --locked
      - cmd: cargo test --workspace --locked
      - cmd: cargo test --workspace --locked --features iterator

  build-minimal:
    desc: Circle CI equivalent of build_minimal job
    cmds:
      - cmd: rustup default nightly
      - cmd: rm Cargo.lock
      - cmd: cargo build -Zminimal-versions --features {{.ALL_FEATURES}}
      - cmd: cargo test --workspace -Zminimal-versions --features {{.ALL_FEATURES}}
      - cmd: rustup default stable
      - cmd: rm Cargo.lock
      - cmd: cargo build

  build-maximal:
    desc: Circle CI equivalent of build_maximal job
    cmds:
      - cmd: cargo build --workspace --locked --features {{.ALL_FEATURES}}
      - cmd: cargo test --workspace --locked --features {{.ALL_FEATURES}}

  clean:
    desc: Removes target artifacts
    cmds:
      - cmd: cargo clean

  clippy-all:
    desc: Runs all clippy variants
    cmds:
      - task: clippy
      - task: clippy11
      - task: clippy12
      - task: clippy13
      - task: clippy_10

  clippy:
    desc: Runs clippy with all features
    cmds:
      - cmd: cargo +nightly clippy --all-targets --features {{.ALL_FEATURES}}

  clippy11:
    desc: Runs clippy with "cosmwasm_1_1" feature
    cmds:
      - cmd: cargo +nightly clippy --all-targets --features cosmwasm_1_1

  clippy12:
    desc: Runs clippy with "cosmwasm_1_2" feature
    cmds:
      - cmd: cargo +nightly clippy --all-targets --features cosmwasm_1_2

  clippy13:
    desc: Runs clippy with "cosmwasm_1_3" feature
    cmds:
      - cmd: cargo +nightly clippy --all-targets --features cosmwasm_1_3

  clippy_10:
    desc: Runs clippy with all features and multitest_api_1_0 feature enabled
    cmds:
      - cmd: cargo +nightly clippy --all-targets --features {{.ALL_FEATURES_1_0}}

  cov:
    desc: Runs code coverage using grcov
    cmds:
      - cmd: ./coverage.sh

  tov:
    desc: Runs code coverage using tarpaulin
    cmds:
      - cmd: ./tarpaulage.sh

  doc:
    desc: Generates documentation with all features
    cmds:
      - cmd: cargo +stable doc --no-deps --features {{.ALL_FEATURES}}

  doc_10:
    desc: Generates documentation with all features and multitest_api_1_0 feature enabled
    cmds:
      - cmd: cargo +stable doc --no-deps --features {{.ALL_FEATURES_1_0}}

  doc-open:
    desc: Generates documentation with all features and opens it in a browser
    cmds:
      - cmd: cargo +stable doc --no-deps --open --features {{.ALL_FEATURES}}

  doc-open_10:
    desc: Generates documentation with all features and multitest_api_1_0 feature enabled and opens it in a browser
    cmds:
      - cmd: cargo +stable doc --no-deps --open --features {{.ALL_FEATURES_1_0}}

  doc-priv:
    desc: Generates documentation with private items and all features
    cmds:
      - cmd: cargo +stable doc --no-deps --document-private-items --features {{.ALL_FEATURES}}

  doc-priv_10:
    desc: Generates documentation with private items and all features and multitest_api_1_0 feature enabled
    cmds:
      - cmd: cargo +stable doc --no-deps --document-private-items --features {{.ALL_FEATURES_1_0}}

  doc-priv-open:
    desc: Generates documentation with private items and all features and opens it in a browser
    cmds:
      - cmd: cargo +stable doc --no-deps --document-private-items --open --features {{.ALL_FEATURES}}

  doc-priv-open_10:
    desc: Generates documentation with private items and all features and multitest_api_1_0 feature enabled and opens it in a browser
    cmds:
      - cmd: cargo +stable doc --no-deps --document-private-items --open --features {{.ALL_FEATURES_1_0}}

  test-all:
    desc: Runs all test variants
    cmds:
      - task: test
      - task: test11
      - task: test12
      - task: test13
      - task: test_10

  test:
    desc: Runs all tests in debug mode with all features
    cmds:
      - cmd: cargo +stable test --features {{.ALL_FEATURES}}

  test11:
    desc: Runs all tests in debug mode with "cosmwasm_1_1" feature
    cmds:
      - cmd: cargo +stable test --features cosmwasm_1_1

  test12:
    desc: Runs all tests in debug mode with "cosmwasm_1_2" feature
    cmds:
      - cmd: cargo +stable test --features cosmwasm_1_2

  test13:
    desc: Runs all tests in debug mode with "cosmwasm_1_3" feature
    cmds:
      - cmd: cargo +stable test --features cosmwasm_1_3

  test_10:
    desc: Runs all tests in debug mode with all features and multitest_api_1_0 feature enabled
    cmds:
      - cmd: cargo +stable test --features {{.ALL_FEATURES_1_0}}